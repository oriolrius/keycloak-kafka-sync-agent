#!/bin/sh
# Validate conventional commit format with project-specific exceptions

commit_msg_file=$1
commit_msg=$(cat "$commit_msg_file")

# Extract first line (header)
header=$(echo "$commit_msg" | head -n1)

# Allow Backlog.md task update messages (generated by backlog CLI)
if echo "$header" | grep -qE "^Update task task-[0-9]+$"; then
    echo "✓ Backlog task update message"
    exit 0
fi

# Allow git-generated messages
if echo "$header" | grep -qE "^(Merge|Revert|Initial commit)"; then
    echo "✓ Git-generated commit message"
    exit 0
fi

# Regex for conventional commits (allowing optional scope and !)
pattern="^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert|security|i18n|config)(\(.+\))?(!)?: .{1,}"

if ! echo "$header" | grep -qE "$pattern"; then
    echo "❌ ERROR: Commit message does not follow Conventional Commits format"
    echo ""
    echo "Commit header: $header"
    echo ""
    echo "Expected format: <type>(<scope>): <subject>"
    echo ""
    echo "Types: feat, fix, docs, style, refactor, perf, test, build, ci, chore, revert, security, config"
    echo "Scope: optional, e.g., (kafka), (keycloak), (api)"
    echo "Subject: imperative mood, lowercase, no period, max 72 chars"
    echo ""
    echo "Examples:"
    echo "  feat(kafka): add SSL encryption support"
    echo "  fix(api): resolve timeout in user endpoint"
    echo "  docs(readme): update installation instructions"
    echo "  chore(deps): upgrade dependencies"
    echo ""
    echo "Allowed exceptions:"
    echo "  - Backlog task updates: 'Update task task-XXX'"
    echo "  - Git-generated: 'Merge branch...', 'Revert...', 'Initial commit'"
    echo ""
    exit 1
fi

# Check subject line doesn't end with period
if echo "$header" | grep -qE "\.$"; then
    echo "❌ ERROR: Commit subject should not end with a period"
    exit 1
fi

# Check subject line doesn't start with uppercase (after the type)
if echo "$header" | grep -qE "^[a-z]+(\([^)]+\))?(!)?: [A-Z]"; then
    echo "⚠️  WARNING: Commit subject should start with lowercase"
    echo "Commit header: $header"
fi

echo "✓ Commit message follows Conventional Commits format"

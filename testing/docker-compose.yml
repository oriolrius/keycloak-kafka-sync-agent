services:
  # Cosmian KMS - Certificate Authority and PKI
  kms:
    image: ${KMS_IMAGE:-ghcr.io/cosmian/kms:latest}
    hostname: ${KMS_HOSTNAME:-kms.example}
    container_name: kms
    ports:
      - "${KMS_HOST_PORT:-57001}:${KMS_CONTAINER_PORT:-9998}"
    volumes:
      - ${KMS_DATA_DIR:-./data/kms}:/root/cosmian-kms
    networks:
      - ${NETWORK_NAME:-keycloak-kafka-backbone}
    restart: unless-stopped

  # Keycloak - Identity Provider (with dev-file)
  keycloak:
    image: ${KEYCLOAK_IMAGE:-quay.io/keycloak/keycloak:26.4}
    hostname: ${KEYCLOAK_HOSTNAME:-keycloak.example}
    container_name: keycloak
    command: start-dev
    environment:
      # Database configuration (dev-file for development)
      KC_DB: ${KC_DB:-dev-file}

      # Admin credentials
      KEYCLOAK_ADMIN: ${KEYCLOAK_ADMIN:-admin}
      KEYCLOAK_ADMIN_PASSWORD: ${KEYCLOAK_ADMIN_PASSWORD:-The2password.}

      # Hostname configuration
      KC_HOSTNAME: ${KEYCLOAK_HOSTNAME:-keycloak.example}
      KC_HOSTNAME_STRICT: ${KC_HOSTNAME_STRICT:-false}
      KC_HOSTNAME_STRICT_HTTPS: ${KC_HOSTNAME_STRICT_HTTPS:-false}

      # HTTP configuration (disabled for HTTPS-only)
      KC_HTTP_ENABLED: ${KC_HTTP_ENABLED:-false}

      # HTTPS configuration
      KC_HTTPS_ENABLED: ${KC_HTTPS_ENABLED:-true}
      KC_HTTPS_PORT: ${KEYCLOAK_HTTPS_CONTAINER_PORT:-8443}
      KC_HTTPS_CERTIFICATE_FILE: ${KC_HTTPS_CERTIFICATE_FILE:-/opt/keycloak/conf/certs/keycloak.crt}
      KC_HTTPS_CERTIFICATE_KEY_FILE: ${KC_HTTPS_CERTIFICATE_KEY_FILE:-/opt/keycloak/conf/certs/keycloak.key}

      # Development mode
      KC_LOG_LEVEL: ${KC_LOG_LEVEL:-INFO}
      KC_METRICS_ENABLED: ${KC_METRICS_ENABLED:-true}
      KC_HEALTH_ENABLED: ${KC_HEALTH_ENABLED:-true}
    ports:
      - "${KEYCLOAK_HTTPS_HOST_PORT:-57003}:${KEYCLOAK_HTTPS_CONTAINER_PORT:-8443}"
    volumes:
      - ${CERTS_DIR:-./certs}:/opt/keycloak/conf/certs:ro
      - ${KEYCLOAK_DATA_DIR:-./data/keycloak}:/opt/keycloak/data
      - ../keycloak-password-sync-spi/target/keycloak-password-sync-spi.jar:/opt/keycloak/providers/keycloak-password-sync-spi.jar:ro
    depends_on:
      - kms
    networks:
      - ${NETWORK_NAME:-keycloak-kafka-backbone}
    restart: unless-stopped

  # Apache Kafka - Message Broker (KRaft mode)
  kafka:
    build:
      context: .
      dockerfile: dockerfiles/Dockerfile.kafka
    image: kafka-testing:latest
    hostname: ${KAFKA_HOSTNAME:-kafka.example}
    container_name: kafka
    ports:
      - "${KAFKA_SSL_HOST_PORT:-57005}:${KAFKA_SSL_CONTAINER_PORT:-9093}"  # SSL only
    environment:
      # Cluster ID for KRaft mode (used by entrypoint script)
      KAFKA_CLUSTER_ID: ${CLUSTER_ID:-MkU3OEVBNTcwNTJENDM2Qk}
    volumes:
      - ${CERTS_DIR:-./certs}/kafka_broker.keystore.jks:/etc/kafka/secrets/kafka_broker.keystore.jks:ro
      - ${CERTS_DIR:-./certs}/kafka.truststore.jks:/etc/kafka/secrets/kafka.truststore.jks:ro
      - ${CERTS_DIR:-./certs}/kafka_keystore_creds:/etc/kafka/secrets/kafka_keystore_creds:ro
      - ${CERTS_DIR:-./certs}/kafka_ssl_key_creds:/etc/kafka/secrets/kafka_ssl_key_creds:ro
      - ${CERTS_DIR:-./certs}/kafka_truststore_creds:/etc/kafka/secrets/kafka_truststore_creds:ro
      - ${KAFKA_DATA_DIR:-./data/kafka}:/var/lib/kafka/data
    depends_on:
      - kms
    networks:
      - ${NETWORK_NAME:-keycloak-kafka-backbone}
    restart: unless-stopped

  # Sync Agent - Keycloak to Kafka synchronization service
  sync-agent:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    image: keycloak-kafka-sync-agent:latest
    hostname: ${AGENT_HOSTNAME:-agent.example}
    container_name: sync-agent
    ports:
      - "${AGENT_HOST_PORT:-57010}:${AGENT_CONTAINER_PORT:-57010}"
    environment:
      # Quarkus Configuration
      QUARKUS_HTTP_PORT: ${AGENT_CONTAINER_PORT:-57010}

      # Database Configuration
      SQLITE_DB_PATH: ${SQLITE_DB_PATH:-/app/data/sync-agent.db}

      # Kafka Configuration (AdminClient uses PLAINTEXT for credential management)
      KAFKA_BOOTSTRAP_SERVERS: ${KAFKA_BOOTSTRAP_SERVERS:-kafka.example:9092}
      KAFKA_SECURITY_PROTOCOL: ${KAFKA_SECURITY_PROTOCOL:-PLAINTEXT}
      KAFKA_REQUEST_TIMEOUT_MS: ${KAFKA_REQUEST_TIMEOUT_MS:-30000}
      KAFKA_DEFAULT_API_TIMEOUT_MS: ${KAFKA_DEFAULT_API_TIMEOUT_MS:-60000}
      KAFKA_CONNECTION_TIMEOUT_MS: ${KAFKA_CONNECTION_TIMEOUT_MS:-10000}

      # Keycloak Configuration
      KEYCLOAK_URL: ${KEYCLOAK_URL:-https://keycloak.example:8443}
      KEYCLOAK_REALM: ${KEYCLOAK_REALM:-master}
      KEYCLOAK_CLIENT_ID: ${KEYCLOAK_CLIENT_ID:-admin-cli}
      KEYCLOAK_ADMIN_USERNAME: ${KEYCLOAK_ADMIN_USERNAME:-admin}
      KEYCLOAK_ADMIN_PASSWORD: ${KEYCLOAK_ADMIN_PASSWORD:-The2password.}
      KEYCLOAK_CONNECTION_TIMEOUT_MS: ${KEYCLOAK_CONNECTION_TIMEOUT_MS:-10000}
      KEYCLOAK_READ_TIMEOUT_MS: ${KEYCLOAK_READ_TIMEOUT_MS:-30000}

      # Reconciliation Configuration
      RECONCILE_INTERVAL_SECONDS: ${RECONCILE_INTERVAL_SECONDS:-120}
      RECONCILE_PAGE_SIZE: ${RECONCILE_PAGE_SIZE:-500}

      # Retention Configuration
      RETENTION_MAX_BYTES: ${RETENTION_MAX_BYTES:-268435456}
      RETENTION_MAX_AGE_DAYS: ${RETENTION_MAX_AGE_DAYS:-30}
      RETENTION_PURGE_INTERVAL_SECONDS: ${RETENTION_PURGE_INTERVAL_SECONDS:-300}

      # Logging
      QUARKUS_LOG_LEVEL: ${AGENT_LOG_LEVEL:-INFO}
    volumes:
      - ${AGENT_DATA_DIR:-./data/sync-agent}:/app/data
    depends_on:
      - kafka
      - keycloak
    networks:
      - ${NETWORK_NAME:-keycloak-kafka-backbone}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:57010/health/ready"]
      interval: 30s
      timeout: 5s
      start_period: 60s
      retries: 3
    restart: unless-stopped

networks:
  keycloak-kafka-backbone:
    driver: bridge
    name: ${NETWORK_NAME:-keycloak-kafka-backbone}
